# Cloud Build configuration for HSS Frontend (SAFE VERSION)
# Triggers: develop branch (dev), v* tags (prod)
# Frontend Firebase Hosting deployment

steps:
  # 1. NPM dependencies download (optimized caching)
  - name: 'gcr.io/cloud-builders/npm'
    id: 'npm-deps'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üì¶ NPM dependencies indiriliyor..."
        echo "Mevcut dizin: $(pwd)"
        
        # Root dizinden HSS'e ge√ß veya mevcut dizinde kal
        if [ -d "HSS" ]; then
          cd HSS
        elif [ ! -f "package.json" ]; then
          echo "‚ùå HSS dizini veya package.json bulunamadƒ±!"
          exit 1
        fi
        
        # Build-time i√ßin NODE_ENV=development olsun ki devDependencies (craco vb.) y√ºklensin
        export NODE_ENV=development
        
        # NPM cache'ini optimize et
        mkdir -p /workspace/.npm
        export NPM_CONFIG_CACHE=/workspace/.npm
        
        # Dependencies'leri indir ve cache'le
        # npm ci, package-lock.json'a sadƒ±k kalƒ±r ve daha hƒ±zlƒ±dƒ±r
        npm ci --prefer-offline --no-audit
        
        echo "‚úÖ Dependencies hazƒ±r!"

  # 2. Test a≈üamasƒ± (optional, can continue on error)
  - name: 'gcr.io/cloud-builders/npm'
    id: 'test'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üß™ Frontend testleri √ßalƒ±≈ütƒ±rƒ±lƒ±yor..."
        if [ -d "HSS" ]; then cd HSS; fi
        
        # node_modules/.bin'i PATH'e ekle
        export PATH=$(pwd)/node_modules/.bin:$PATH
        export CI=true
        
        if [ "${_ENVIRONMENT}" = "prod" ]; then
          echo "üîç Production testleri..."
          npm test -- --watchAll=false --passWithNoTests || exit 1
        else
          echo "‚ö° Development testleri..."
          npm test -- --watchAll=false --passWithNoTests || echo "‚ö†Ô∏è Testler atlandƒ± (dev mode)"
        fi
    waitFor: ['npm-deps']

  # 3. Build a≈üamasƒ±
  - name: 'gcr.io/cloud-builders/npm'
    id: 'build'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üî® Frontend build ediliyor..."
        if [ -d "HSS" ]; then cd HSS; fi
        
        # node_modules/.bin'i PATH'e ekle (craco i√ßin kritik!)
        export PATH=$(pwd)/node_modules/.bin:$PATH
        
        # Environment variables ayarla
        if [ "${_ENVIRONMENT}" = "prod" ]; then
          export NODE_ENV=production
          export REACT_APP_ENV=production
          # Production backend URL
          LOCAL_BACKEND_URL="${_BACKEND_URL_PROD:-https://hss-backend-2ez5rneaua-ey.a.run.app}"
          echo "üîó Production backend URL: $$LOCAL_BACKEND_URL"
        else
          # Development/Staging i√ßin de production build alƒ±yoruz ama env farklƒ±
          export NODE_ENV=production
          export REACT_APP_ENV=development
          # Development/Staging backend URL
          LOCAL_BACKEND_URL="${_BACKEND_URL:-https://hss-backend-dev-296268886725.europe-west3.run.app}"
          echo "üîó Development backend URL: $$LOCAL_BACKEND_URL"
        fi
        
        # .env.production dosyasƒ± olu≈ütur (React build i√ßin)
        FIREBASE_PROJECT_ID="${_FIREBASE_PROJECT_ID:-hss-cloud-473511}"
        echo "REACT_APP_API_URL=$$LOCAL_BACKEND_URL" > .env.production
        echo "REACT_APP_FIREBASE_PROJECT_ID=$$FIREBASE_PROJECT_ID" >> .env.production
        
        # Environment variable'larƒ± export et
        export REACT_APP_API_URL="$$LOCAL_BACKEND_URL"
        export REACT_APP_FIREBASE_PROJECT_ID="${_FIREBASE_PROJECT_ID:-hss-cloud-473511}"
        
        # Build
        npm run build
        
        # Build output kontrol√º
        if [ ! -d "build" ]; then
          echo "‚ùå Build dizini olu≈üturulmadƒ±!"
          exit 1
        fi
        
        echo "‚úÖ Build ba≈üarƒ±lƒ±! Build size:"
        du -sh build
        
    waitFor: ['npm-deps']

  # 4. Firebase Hosting deploy
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'firebase-deploy'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        echo "üî• Firebase Hosting deploy ba≈ülƒ±yor..."
        if [ -d "HSS" ]; then cd HSS; fi
        
        # Firebase CLI
        npm install -g firebase-tools
        
        # Firebase project'i ayarla
        firebase use "${PROJECT_ID}" || echo "‚ö†Ô∏è Firebase project ayarlanamadƒ±"
        
        # Deploy target belirle
        if [ "${_ENVIRONMENT}" = "prod" ]; then
          echo "üöÄ Production deploy (live channel)..."
          firebase deploy --only hosting:prod --project="${PROJECT_ID}" --non-interactive
        else
          echo "üëÄ Staging deploy (preview channel)..."
          # Commit SHA'sƒ±nƒ±n ilk 7 karakterini al
          SHORT_SHA_VAL=$$(echo "${SHORT_SHA}" | cut -c1-7)
          CHANNEL_ID="staging-$$SHORT_SHA_VAL"
          
          # Preview channel'a deploy et (expires 7d)
          firebase hosting:channel:deploy "$$CHANNEL_ID" --only dev --project="${PROJECT_ID}" --expires 7d --non-interactive
        fi
        
        echo "‚úÖ Firebase deploy ba≈üarƒ±lƒ±!"

    waitFor: ['build']

  # 5. Cloud Storage backup (build artifacts)
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'storage-backup'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        
        echo "üì¶ Cloud Storage'a backup y√ºkleniyor..."
        echo "Mevcut dizin: $(pwd)"
        
        # Root dizinden HSS'e ge√ß veya mevcut dizinde kal
        if [ -d "HSS" ]; then
          cd HSS
          echo "HSS dizinine ge√ßildi"
        elif [ -d "build" ]; then
          echo "Mevcut dizinde build bulundu, burada kalƒ±yoruz"
        else
          echo "‚ùå Build dizini bulunamadƒ±!"
          exit 1
        fi
        
        MY_BUCKET="gs://hss-releases-${PROJECT_ID}"
        MY_VERSION="${_TAG_NAME}"
        MY_PATH="$$MY_BUCKET/releases/$$MY_VERSION/frontend/"
        
        # Build'i Cloud Storage'a y√ºkle
        echo "üì§ Build dosyalarƒ± y√ºkleniyor: $$MY_PATH"
        gsutil -m cp -r build/* "$$MY_PATH"
        
        # Latest pointer'ƒ±nƒ± g√ºncelle
        echo "üîó Latest pointer g√ºncelleniyor..."
        gsutil -m rsync -r -d "$$MY_PATH" "$$MY_BUCKET/releases/latest/frontend/"
        
        echo "‚úÖ Cloud Storage backup tamamlandƒ±!"

    waitFor: ['build']

  # 6. Release artifacts (only prod)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'release'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        if [ "${_ENVIRONMENT}" = "prod" ]; then
          echo "üì¶ Release artifacts olu≈üturuluyor..."
          
          MY_VERSION="${_TAG_NAME}"
          MY_BUCKET="gs://hss-releases-${PROJECT_ID}"
          
          DEPLOYED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          BUILD_SIZE=$(du -sh build 2>/dev/null | cut -f1 || echo 'unknown')
          # JSON manifest olu≈ütur (echo kullanarak YAML indentation sorununu √∂nle)
          echo "{" > manifest.json
          echo "  \"version\": \"$$MY_VERSION\"," >> manifest.json
          echo "  \"environment\": \"production\"," >> manifest.json
          echo "  \"deployed_at\": \"$$DEPLOYED_AT\"," >> manifest.json
          echo "  \"commit_sha\": \"${SHORT_SHA}\"," >> manifest.json
          echo "  \"service\": \"hss-frontend\"," >> manifest.json
          echo "  \"build_size\": \"$$BUILD_SIZE\"" >> manifest.json
          echo "}" >> manifest.json
          
          # Manifest'i y√ºkle
          gsutil -m cp manifest.json "$$MY_BUCKET/releases/$$MY_VERSION/frontend/manifest.json"
          gsutil -m cp manifest.json "$$MY_BUCKET/releases/latest/frontend/manifest.json"
          
          echo "‚úÖ Release artifacts y√ºklendi!"
        else
          echo "‚ÑπÔ∏è Dev ortamƒ± - release atlandƒ±"
        fi

    waitFor: ['firebase-deploy', 'storage-backup']

  # 7. Monitoring metrics
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'monitoring'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üìä Monitoring kaydƒ± g√∂nderiliyor..."
        gcloud logging write hss-deployment \
          "Frontend deployment completed successfully" \
          --severity=INFO \
          --payload-type=json \
          --payload='{
            "service": "hss-frontend",
            "environment": "${_ENVIRONMENT}",
            "version": "${_TAG_NAME}",
            "commit_sha": "${SHORT_SHA}",
            "deployment_time": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
          }' || echo "‚ö†Ô∏è Monitoring g√∂nderilemedi"
    waitFor: ['release']

# Substitution variables
substitutions:
  _ENVIRONMENT: 'dev'
  _TAG_NAME: 'dev'
  _BACKEND_URL: 'https://hss-backend-dev-296268886725.europe-west3.run.app'  # Development/Staging backend URL
  _BACKEND_URL_PROD: 'https://hss-backend-2ez5rneaua-ey.a.run.app'  # Production backend URL
  _FIREBASE_PROJECT_ID: 'hss-cloud-473511'  # Firebase project ID
  _FIREBASE_TOKEN: ''  # Optional: Firebase CI token for authentication
  _FIREBASE_SERVICE_ACCOUNT_KEY: ''  # Optional: Firebase service account key JSON

# Options (optimized for performance)
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'  # 8 vCPU, 8GB RAM - optimal for npm + Firebase
  diskSizeGb: 50  # Sufficient for node_modules and build artifacts
  substitution_option: 'ALLOW_LOOSE'
  dynamic_substitutions: true
  env:
    - 'NODE_ENV=production'
    - 'NPM_CONFIG_LOGLEVEL=warn'

timeout: '1200s'  # 20 minutes timeout for build and deploy

