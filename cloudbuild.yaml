# Cloud Build configuration for HSS Frontend (SAFE VERSION)
# Triggers: develop branch (dev), v* tags (prod)
# Frontend Firebase Hosting deployment

steps:
  # 1. NPM dependencies download (optimized caching)
  - name: 'gcr.io/cloud-builders/npm'
    id: 'npm-deps'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ“¦ NPM dependencies indiriliyor..."
        echo "Mevcut dizin: $(pwd)"
        echo "Dizin iÃ§eriÄŸi: $(ls -la)"
        # Root dizinden HSS'e geÃ§ veya mevcut dizinde kal
        if [ -d "HSS" ]; then
          cd HSS
          echo "HSS dizinine geÃ§ildi"
        elif [ -f "package.json" ]; then
          echo "Mevcut dizinde package.json bulundu, burada kalÄ±yoruz"
        else
          echo "âŒ HSS dizini veya package.json bulunamadÄ±!"
          echo "Mevcut dizin iÃ§eriÄŸi:"
          ls -la
          exit 1
        fi
        
        # NPM cache'ini optimize et
        mkdir -p /workspace/.npm
        export NPM_CONFIG_CACHE=/workspace/.npm
        
        # Dependencies'leri indir ve cache'le
        npm ci --prefer-offline --no-audit
        
        echo "âœ… Dependencies hazÄ±r ve cache'lenmiÅŸ!"

  # 2. Test aÅŸamasÄ± (optional, can continue on error)
  - name: 'gcr.io/cloud-builders/npm'
    id: 'test'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ§ª Frontend testleri Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
        echo "Mevcut dizin: $(pwd)"
        # Root dizinden HSS'e geÃ§ veya mevcut dizinde kal
        if [ -d "HSS" ]; then
          cd HSS
          echo "HSS dizinine geÃ§ildi"
        elif [ -f "package.json" ]; then
          echo "Mevcut dizinde package.json bulundu, burada kalÄ±yoruz"
        else
          echo "âŒ HSS dizini veya package.json bulunamadÄ±!"
          exit 1
        fi
        
        if [ "${_ENVIRONMENT}" = "prod" ]; then
          echo "ðŸ” Production testleri - tÃ¼m testler..."
          npm test -- --coverage --watchAll=false --ci || exit 1
        else
          echo "âš¡ Development testleri..."
          npm test -- --coverage --watchAll=false --ci || echo "âš ï¸ Testler atlandÄ± (dev mode)"
        fi
        echo "âœ… Testler tamamlandÄ±!"
    waitFor: ['npm-deps']

  # 3. Build aÅŸamasÄ±
  - name: 'gcr.io/cloud-builders/npm'
    id: 'build'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ”¨ Frontend build ediliyor..."
        echo "Mevcut dizin: $(pwd)"
        # Root dizinden HSS'e geÃ§ veya mevcut dizinde kal
        if [ -d "HSS" ]; then
          cd HSS
          echo "HSS dizinine geÃ§ildi"
        elif [ -f "package.json" ]; then
          echo "Mevcut dizinde package.json bulundu, burada kalÄ±yoruz"
        else
          echo "âŒ HSS dizini veya package.json bulunamadÄ±!"
          exit 1
        fi
        
        # Environment variables ayarla
        if [ "${_ENVIRONMENT}" = "prod" ]; then
          export NODE_ENV=production
          export REACT_APP_ENV=production
          # Production backend URL
          BACKEND_API_URL="${_BACKEND_URL_PROD:-https://hss-backend-2ez5rneaua-ey.a.run.app}"
          echo "ðŸ”— Production backend URL: ${BACKEND_API_URL}"
        else
          export NODE_ENV=development
          export REACT_APP_ENV=development
          # Development/Staging backend URL
          BACKEND_API_URL="${_BACKEND_URL:-https://hss-backend-dev-296268886725.europe-west3.run.app}"
          echo "ðŸ”— Development backend URL: ${BACKEND_API_URL}"
        fi
        
        # .env.production dosyasÄ± oluÅŸtur (React build iÃ§in)
        FIREBASE_PROJECT_ID="${_FIREBASE_PROJECT_ID:-hss-cloud-473511}"
        echo "REACT_APP_API_URL=${BACKEND_API_URL}" > .env.production
        echo "REACT_APP_FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}" >> .env.production
        
        echo "ðŸ“ .env.production dosyasÄ± oluÅŸturuldu:"
        cat .env.production | sed 's/REACT_APP_API_URL=.*/REACT_APP_API_URL=***/' | sed 's/REACT_APP_FIREBASE_PROJECT_ID=.*/REACT_APP_FIREBASE_PROJECT_ID=***/'
        
        # Environment variable'larÄ± export et
        export REACT_APP_API_URL="${BACKEND_API_URL}"
        export REACT_APP_FIREBASE_PROJECT_ID="${_FIREBASE_PROJECT_ID:-hss-cloud-473511}"
        
        # Build
        npm run build
        
        # Build output kontrolÃ¼
        if [ ! -d "build" ]; then
          echo "âŒ Build dizini oluÅŸturulmadÄ±!"
          exit 1
        fi
        
        echo "âœ… Build baÅŸarÄ±lÄ±! Build size:"
        du -sh build
        
    waitFor: ['npm-deps']

  # 4. Firebase Hosting deploy
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'firebase-deploy'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        
        echo "ðŸ”¥ Firebase Hosting deploy baÅŸlÄ±yor..."
        echo "Environment: ${_ENVIRONMENT}"
        echo "Mevcut dizin: $(pwd)"
        
        # Root dizinden HSS'e geÃ§ veya mevcut dizinde kal
        if [ -d "HSS" ]; then
          cd HSS
          echo "HSS dizinine geÃ§ildi"
        elif [ -f "firebase.json" ]; then
          echo "Mevcut dizinde firebase.json bulundu, burada kalÄ±yoruz"
        else
          echo "âŒ HSS dizini veya firebase.json bulunamadÄ±!"
          exit 1
        fi
        
        # Firebase CLI'yi kur
        npm install -g firebase-tools
        
        # Firebase authentication
        echo "ðŸ” Firebase authentication..."
        if [ -n "${_FIREBASE_TOKEN:-}" ]; then
          echo "Token ile authentication kullanÄ±lÄ±yor..."
          export FIREBASE_TOKEN="${_FIREBASE_TOKEN}"
        else
          echo "Service account ile authentication deneniyor..."
          # Service account key'i Secret Manager'dan al (opsiyonel)
          if [ -n "${_FIREBASE_SERVICE_ACCOUNT_KEY:-}" ]; then
            echo "${_FIREBASE_SERVICE_ACCOUNT_KEY}" > /tmp/firebase-key.json
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-key.json
          else
            # Cloud Build service account'u kullan (default)
            echo "Cloud Build service account kullanÄ±lÄ±yor..."
          fi
        fi
        
        # Firebase project'i ayarla
        firebase use "${PROJECT_ID}" || echo "âš ï¸ Firebase project ayarlanamadÄ±, deploy sÄ±rasÄ±nda belirtilecek"
        
        # Deploy target belirle
        if [ "${_ENVIRONMENT}" = "prod" ]; then
          MY_TARGET="prod"
        else
          MY_TARGET="dev"
        fi
        
        echo "ðŸ“¤ Deploying to Firebase Hosting target: ${MY_TARGET}"
        
        # Firebase deploy
        firebase deploy --only hosting:${MY_TARGET} --project="${PROJECT_ID}" --non-interactive
        
        echo "âœ… Firebase deploy baÅŸarÄ±lÄ±!"

    waitFor: ['build']

  # 5. Cloud Storage backup (build artifacts)
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'storage-backup'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        
        echo "ðŸ“¦ Cloud Storage'a backup yÃ¼kleniyor..."
        echo "Mevcut dizin: $(pwd)"
        
        # Root dizinden HSS'e geÃ§ veya mevcut dizinde kal
        if [ -d "HSS" ]; then
          cd HSS
          echo "HSS dizinine geÃ§ildi"
        elif [ -d "build" ]; then
          echo "Mevcut dizinde build bulundu, burada kalÄ±yoruz"
        else
          echo "âŒ Build dizini bulunamadÄ±!"
          exit 1
        fi
        
        MY_BUCKET="gs://hss-releases-${PROJECT_ID}"
        MY_VERSION="${_TAG_NAME}"
        MY_PATH="${MY_BUCKET}/releases/${MY_VERSION}/frontend/"
        
        # Build'i Cloud Storage'a yÃ¼kle
        echo "ðŸ“¤ Build dosyalarÄ± yÃ¼kleniyor: ${MY_PATH}"
        gsutil -m cp -r build/* "${MY_PATH}"
        
        # Latest pointer'Ä±nÄ± gÃ¼ncelle
        echo "ðŸ”— Latest pointer gÃ¼ncelleniyor..."
        gsutil -m rsync -r -d "${MY_PATH}" "${MY_BUCKET}/releases/latest/frontend/"
        
        echo "âœ… Cloud Storage backup tamamlandÄ±!"

    waitFor: ['build']

  # 6. Release artifacts (only prod)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'release'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        if [ "${_ENVIRONMENT}" = "prod" ]; then
          echo "ðŸ“¦ Release artifacts oluÅŸturuluyor..."
          
          MY_VERSION="${_TAG_NAME}"
          MY_BUCKET="gs://hss-releases-${PROJECT_ID}"
          
          DEPLOYED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          BUILD_SIZE=$(du -sh build 2>/dev/null | cut -f1 || echo 'unknown')
          cat > manifest.json << MANIFEST_EOF
{
  "version": "${MY_VERSION}",
  "environment": "production",
  "deployed_at": "${DEPLOYED_AT}",
  "commit_sha": "${SHORT_SHA}",
  "service": "hss-frontend",
  "build_size": "${BUILD_SIZE}"
}
MANIFEST_EOF
          
          # Manifest'i yÃ¼kle
          gsutil -m cp manifest.json "${MY_BUCKET}/releases/${MY_VERSION}/frontend/manifest.json"
          gsutil -m cp manifest.json "${MY_BUCKET}/releases/latest/frontend/manifest.json"
          
          echo "âœ… Release artifacts yÃ¼klendi!"
        else
          echo "â„¹ï¸ Dev ortamÄ± - release atlandÄ±"
        fi

    waitFor: ['firebase-deploy', 'storage-backup']

  # 7. Monitoring metrics
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'monitoring'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ“Š Monitoring kaydÄ± gÃ¶nderiliyor..."
        gcloud logging write hss-deployment \
          "Frontend deployment completed successfully" \
          --severity=INFO \
          --payload-type=json \
          --payload='{
            "service": "hss-frontend",
            "environment": "${_ENVIRONMENT}",
            "version": "${_TAG_NAME}",
            "commit_sha": "${SHORT_SHA}",
            "deployment_time": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
          }' || echo "âš ï¸ Monitoring gÃ¶nderilemedi"
    waitFor: ['release']

# Substitution variables
substitutions:
  _ENVIRONMENT: 'dev'
  _TAG_NAME: 'dev'
  _BACKEND_URL: 'https://hss-backend-dev-296268886725.europe-west3.run.app'  # Development/Staging backend URL
  _BACKEND_URL_PROD: 'https://hss-backend-2ez5rneaua-ey.a.run.app'  # Production backend URL
  _FIREBASE_PROJECT_ID: 'hss-cloud-473511'  # Firebase project ID
  _FIREBASE_TOKEN: ''  # Optional: Firebase CI token for authentication
  _FIREBASE_SERVICE_ACCOUNT_KEY: ''  # Optional: Firebase service account key JSON

# Options (optimized for performance)
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_4'  # 4 vCPU, 4GB RAM - optimal for npm + Firebase
  diskSizeGb: 50  # Sufficient for node_modules and build artifacts
  substitution_option: 'ALLOW_LOOSE'
  dynamic_substitutions: true
  env:
    - 'NODE_ENV=production'
    - 'NPM_CONFIG_LOGLEVEL=warn'

timeout: '1200s'  # 20 minutes timeout for build and deploy

